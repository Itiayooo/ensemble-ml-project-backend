from fastapi import APIRouter, Depends, HTTPException
from fastapi.responses import StreamingResponse
from sqlalchemy.orm import Session
from app.database import get_db
from app import crud
import io
from datetime import datetime

router = APIRouter(prefix="/api/results", tags=["Results"])


@router.get("/download/{session_id}")
async def download_report(session_id: int, db: Session = Depends(get_db)):
    """
    Generate and download assessment report as text file.
    (In production, this would generate a PDF)
    """
    # Get session data
    session = crud.get_session_by_id(db, session_id)
    if not session:
        raise HTTPException(status_code=404, detail="Session not found")
    
    # Get all results
    quiz_responses = crud.get_session_quiz_results(db, session_id)
    coding_submissions = crud.get_session_coding_submissions(db, session_id)
    audit_submissions = crud.get_session_audit_submissions(db, session_id)
    
    # Calculate scores
    quiz_correct = sum(1 for r in quiz_responses if r.is_correct)
    quiz_score = (quiz_correct / len(quiz_responses)) * 100 if quiz_responses else 0
    
    coding_score = coding_submissions[0].tests_passed / coding_submissions[0].tests_total * 100 if coding_submissions else 0
    
    audit_score = 0
    if audit_submissions:
        audit = audit_submissions[0]
        audit_score = (audit.bugs_fixed / audit.bugs_total) * 100 if audit.bugs_total > 0 else 0
    
    # Calculate final employability
    employability = (quiz_score * 0.30) + (coding_score * 0.40) + (audit_score * 0.30)
    
    # Generate report text
    report = f"""
================================================================================
                    SKILLASSESS PRO - ASSESSMENT REPORT
================================================================================

Session ID: {session_id}
Date: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}

================================================================================
                           EMPLOYABILITY INDEX
================================================================================

Overall Score: {employability:.1f}%
Category: {"Hire" if employability >= 75 else "Consider" if employability >= 60 else "Develop"}

================================================================================
                          STAGE PERFORMANCE
================================================================================

STAGE A - COMPUTATIONAL THINKING QUIZ
  Score: {quiz_score:.1f}%
  Correct Answers: {quiz_correct}/{len(quiz_responses) if quiz_responses else 0}
  Total Time: {quiz_responses[0].time_spent if quiz_responses else 0} seconds

STAGE B - CODING CHALLENGE
  Score: {coding_score:.1f}%
  Tests Passed: {coding_submissions[0].tests_passed if coding_submissions else 0}/{coding_submissions[0].tests_total if coding_submissions else 0}
  Language: {coding_submissions[0].language if coding_submissions else 'N/A'}
  Lines of Code: {coding_submissions[0].lines_of_code if coding_submissions else 0}
  Cyclomatic Complexity: {coding_submissions[0].cyclomatic_complexity if coding_submissions else 0}
  Run Attempts: {coding_submissions[0].run_count if coding_submissions else 0}

STAGE C - LOGIC AUDIT
  Score: {audit_score:.1f}%
  Bugs Fixed: {audit_submissions[0].bugs_fixed if audit_submissions else 0}/{audit_submissions[0].bugs_total if audit_submissions else 0}
  Edit Count: {audit_submissions[0].edit_count if audit_submissions else 0}
  Lines Modified: {len(audit_submissions[0].lines_changed) if audit_submissions and audit_submissions[0].lines_changed else 0}

================================================================================
                          RECOMMENDATIONS
================================================================================

{generate_recommendations(employability, quiz_score, coding_score, audit_score)}

================================================================================
                    Generated by SkillAssess Pro
                Machine Learning-Based Skill Assessment
================================================================================
"""
    
    # Create file-like object
    report_bytes = report.encode('utf-8')
    
    return StreamingResponse(
        io.BytesIO(report_bytes),
        media_type="text/plain",
        headers={
            "Content-Disposition": f"attachment; filename=skillassess_report_{session_id}.txt"
        }
    )


def generate_recommendations(overall: float, quiz: float, coding: float, audit: float) -> str:
    """Generate personalized recommendations"""
    recs = []
    
    if overall >= 75:
        recs.append("✓ Strong performance across all stages")
        recs.append("✓ Ready for entry-level positions")
        recs.append("→ Focus on building portfolio projects")
    elif overall >= 60:
        recs.append("✓ Good foundational skills")
        recs.append("→ Spend 2-3 months on targeted practice")
    else:
        recs.append("→ Significant improvement needed")
        recs.append("→ Complete structured learning path")
    
    if quiz < 60:
        recs.append("→ Review CS fundamentals (algorithms, data structures)")
    if coding < 60:
        recs.append("→ Practice daily coding challenges (LeetCode Easy/Medium)")
    if audit < 60:
        recs.append("→ Study code review best practices and debugging techniques")
    
    return "\n".join(recs)